<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Ø§ØµØ¯Ø§Ø± ØªØ³ÙˆÙŠØ© Ø°ÙƒÙŠØ© â€” Ù†Ø¸Ø§Ù… Ù…Ø­Ø§Ø³Ø¨Ø© Ù…Ø­Ù„ÙŠ</title>
<style>
:root{--blue:#2878ff;--blue-2:#eaf1ff;--text:#0f172a;--muted:#64748b;--danger:#dc3545;--ok:#16a34a;--card:#ffffff;--line:#e5e7eb}
*{box-sizing:border-box}html,body{height:100%}body{margin:0;font-family:Tahoma, Arial, sans-serif;background:var(--blue-2);color:var(--text)}
header{position:sticky;top:0;z-index:10;background:var(--blue);color:#fff;padding:10px 14px;box-shadow:0 2px 10px rgba(0,0,0,.08)}
header h1{margin:0;font-size:18px}header .sub{opacity:.95;font-size:13px}
header .owner-badge{margin-top:6px;font-size:14px;color:#eaf5ff;background:rgba(255,255,255,.12);display:inline-block;padding:6px 10px;border-radius:10px}
main{padding:12px;max-width:1100px;margin:auto;padding-bottom:160px}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;margin:10px 0;box-shadow:0 1px 6px rgba(0,0,0,.04)}
h3{margin:6px 0 10px}
.row{display:flex;flex-wrap:wrap;gap:10px}.col{flex:1;min-width:200px}label{font-size:13px;color:#111}
input,select,textarea,button{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:12px;font-size:16px;background:#fff}
textarea{min-height:70px;resize:vertical}button{border:none;cursor:pointer}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;border-radius:12px;padding:10px 14px;font-size:14px}
.btn-primary{background:var(--blue);color:#fff}.btn-outline{background:#fff;border:1px solid var(--line);color:#111}
.btn-danger{background:var(--danger);color:#fff}.btn-ok{background:var(--ok);color:#fff}
.hint{font-size:12px;color:var(--muted)}
.list .item{display:flex;justify-content:space-between;align-items:center;gap:10px;padding:8px 0;border-bottom:1px dashed var(--line)}
.list .item:last-child{border-bottom:none}.list .meta{flex:1}
.kpi{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}.kpi .box{background:#f3f7ff;border:1px solid #e3ecff;border-radius:12px;padding:10px;text-align:center}.kpi .box b{display:block;font-size:16px}
table{width:100%;border-collapse:collapse;margin-top:10px}th,td{border:1px solid var(--line);padding:8px;text-align:center;font-size:14px}th{background:#f8fbff}
.tabs{position:fixed;bottom:0;left:0;right:0;background:#fff;border-top:1px solid var(--line);display:flex}
.tab{flex:1}.tab button{width:100%;background:#fff;border:none;padding:12px 0}.tab.active{background:#f6f8ff}
.tag{display:inline-block;padding:.2rem .5rem;border-radius:999px;background:#eef2ff;border:1px solid #e5e7eb;font-size:12px}
.subtle{background:#f9fbff;border:1px solid #eef2ff;border-radius:12px;padding:10px;margin-top:8px}
.separator{height:1px;background:var(--line);margin:8px 0}.print-hide{}
.badge{display:inline-block;padding:.25rem .6rem;border-radius:999px;border:1px solid #dbeafe;background:#eff6ff;font-size:12px}
@media print{header,nav.tabs,.print-hide{display:none !important}body{background:#fff}.card{box-shadow:none;border:none;padding:0;margin:0}.page{page-break-after:always;margin-bottom:30px}}
</style>
</head>
<body>
<header class="print-hide">
  <h1>Ù†Ø¸Ø§Ù… Ù…Ø­Ø§Ø³Ø¨Ø© Ù…Ø­Ù„ÙŠ</h1>
  <div class="sub">Ø§Ù„Ù…Ø§Ù„Ùƒ: <b>Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡ Ø£Ø¨Ùˆ Ø¹ÙˆØ¶</b></div>
  <div class="owner-badge">Ø±ØµÙŠØ¯ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ: <b id="ownerBalanceVal">0</b></div>
</header>

<main>
  <div class="card print-hide">
    <div class="row">
      <div class="col">
        <label>Ø§Ù„Ù…Ø­Ù„</label>
        <select id="storeSelect" onchange="changeStore()">
          <option value="store1">Ø±ÙˆØ§Ù† Ø¨ÙŠØ¨ÙŠ</option>
          <option value="store2">Ø¬Ù†ØªÙ„ Ø¨ÙŠØ¨ÙŠ Ø¹Ø¨ÙˆØ¯</option>
          <option value="store3">Ø¨Ø³Ø·Ø©</option>
        </select>
      </div>
      <div class="col">
        <label>ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…</label>
        <input type="date" id="todayInput"/>
      </div>
      <div class="col">
        <label>&nbsp;</label>
        <button class="btn btn-primary" onclick="settleDay()">ØªØ³ÙˆÙŠØ© Ø§Ù„ÙŠÙˆÙ… Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ</button>
      </div>
    </div>
    <div class="hint">ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²ØŒ ÙˆØªØ¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª.</div>
  </div>

  <!-- Ø¥Ø¯Ø®Ø§Ù„ -->
  <section class="card" data-tab="input">
    <h3>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h3>
    <div class="row">
      <div class="col"><input type="number" id="saleAmount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº"></div>
      <div class="col">
        <select id="saleType">
          <option value="ÙƒØ§Ø´">ÙƒØ§Ø´</option>
          <option value="Ø¨Ù†Ùƒ">Ø¨Ù†Ùƒ</option>
        </select>
      </div>
      <div class="col"><input type="text" id="saleNote" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø³Ù… Ø§Ù„Ù…Ø´ØªØ±ÙŠ/Ø§Ù„ØµÙ†Ù/Ø¬ÙˆØ§Ù„)"></div>
    </div>
    <div class="row"><div class="col"><button class="btn btn-ok" onclick="addSale()">â• Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ¹</button></div></div>
    <div class="list" id="recentSales"></div>

    <h3 style="margin-top:18px">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</h3>
    <div class="row">
      <div class="col"><input type="text" id="expenseDesc" placeholder="ÙˆØµÙ Ø§Ù„Ù…ØµØ±ÙˆÙ"></div>
      <div class="col"><input type="number" id="expenseAmount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº"></div>
      <div class="col">
        <select id="expenseType">
          <option value="ÙƒØ§Ø´">ÙƒØ§Ø´</option>
          <option value="Ø¨Ù†Ùƒ">Ø¨Ù†Ùƒ</option>
        </select>
      </div>
      <div class="col">
        <select id="expenseTarget" onchange="toggleExpenseTarget()">
          <option value="normal">Ù…ØµØ±ÙˆÙ Ø¹Ø§Ø¯ÙŠ</option>
          <option value="lender">Ø³Ø¯Ø§Ø¯ Ù„Ù…Ø³Ù„Ù</option>
          <option value="trader">Ø³Ø¯Ø§Ø¯ Ù„ØªØ§Ø¬Ø±</option>
        </select>
      </div>
    </div>
    <div class="row print-hide" id="expLenderRow" style="display:none">
      <div class="col"><label>Ø§Ù„Ù…ÙØ³Ù„Ù</label><select id="exp_lender"></select></div>
      <div class="col">
        <select id="exp_lender_source">
          <option value="shop_cash">Ù…Ù† ÙƒØ§Ø´ Ø§Ù„Ù…Ø­Ù„</option>
          <option value="owner_cash">Ù…Ù† ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ</option>
        </select>
      </div>
    </div>
    <div class="row print-hide" id="expTraderRow" style="display:none">
      <div class="col"><label>Ø§Ù„ØªØ§Ø¬Ø±</label><select id="exp_trader"></select></div>
    </div>
    <div class="row">
      <div class="col"><input type="text" id="expenseNote" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></div>
    </div>
    <div class="row"><div class="col"><button class="btn btn-ok" onclick="addExpense()">â• Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ</button></div></div>
    <div class="list" id="recentExpenses"></div>
  </section>

  <!-- Ø§Ù„Ø³ÙÙ„Ù -->
  <section class="card" data-tab="loans">
    <h3>Ø§Ù„Ø³ÙÙ„Ù</h3>
    <div class="subtle print-hide">
      <h4>Ø¥Ø¶Ø§ÙØ© Ù…ÙØ³Ù„Ù</h4>
      <div class="row">
        <div class="col"><input type="text" id="l_name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙØ³Ù„Ù"></div>
        <div class="col"><input type="text" id="l_phone" placeholder="Ø¬ÙˆØ§Ù„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></div>
      </div>
      <button class="btn btn-ok" onclick="addLender()">â• Ø¥Ø¶Ø§ÙØ©</button>
    </div>

    <div class="subtle print-hide">
      <h4>ØªØ³Ø¬ÙŠÙ„ Ø³Ù„ÙØ© Ø¬Ø¯ÙŠØ¯Ø© (ÙƒØ§Ø´)</h4>
      <div class="row">
        <div class="col"><label>Ø§Ù„Ù…ÙØ³Ù„Ù</label><select id="loan_person"></select></div>
        <div class="col"><input type="number" id="loan_amount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº"></div>
      </div>
      <input type="text" id="loan_note" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
      <button class="btn btn-primary" onclick="takeLoan()">ğŸ’µ ØªØ³Ø¬ÙŠÙ„ Ø³Ù„ÙØ©</button>
    </div>

    <div class="subtle print-hide">
      <h4>Ø³Ø¯Ø§Ø¯ Ø³Ù„ÙØ©</h4>
      <div class="row">
        <div class="col"><label>Ø§Ù„Ù…ÙØ³Ù„Ù</label><select id="repay_person"></select></div>
        <div class="col"><input type="number" id="repay_amount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº"></div>
        <div class="col">
          <select id="repay_source">
            <option value="shop_cash">Ù…Ù† ÙƒØ§Ø´ Ø§Ù„Ù…Ø­Ù„</option>
            <option value="owner_cash">Ù…Ù† ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ</option>
          </select>
        </div>
      </div>
      <input type="text" id="repay_note" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
      <button class="btn btn-outline" onclick="repayLoan()">â†©ï¸ ØªØ³Ø¬ÙŠÙ„ Ø³Ø¯Ø§Ø¯</button>
    </div>

    <div class="subtle">
      <h4>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙØ³Ù„ÙÙŠÙ† ÙˆØ£Ø±ØµØ¯ØªÙ‡Ù…</h4>
      <div id="lendersList"></div>
    </div>
  </section>

  <!-- Ø§Ù„ØªØ¬Ø§Ø± -->
  <section class="card" data-tab="traders">
    <h3>Ø§Ù„ØªØ¬Ø§Ø±</h3>
    <div class="subtle print-hide">
      <h4>Ø¥Ø¶Ø§ÙØ© ØªØ§Ø¬Ø±</h4>
      <div class="row">
        <div class="col"><input type="text" id="t_name" placeholder="Ø§Ø³Ù… Ø§Ù„ØªØ§Ø¬Ø±"></div>
        <div class="col"><input type="text" id="t_phone" placeholder="Ø¬ÙˆØ§Ù„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></div>
      </div>
      <button class="btn btn-ok" onclick="addTrader()">â• Ø¥Ø¶Ø§ÙØ©</button>
    </div>

    <div class="subtle print-hide">
      <h4>Ø´Ø±Ø§Ø¡ Ù…Ù† ØªØ§Ø¬Ø± (ÙØ§ØªÙˆØ±Ø© Ø¨Ø¶Ø§Ø¹Ø©)</h4>
      <div class="row">
        <div class="col"><label>Ø§Ù„ØªØ§Ø¬Ø±</label><select id="p_trader"></select></div>
        <div class="col"><input type="number" id="p_total" placeholder="Ù‚ÙŠÙ…Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©"></div>
      </div>
      <div class="row">
        <div class="col"><input type="number" id="p_from_shop_cash" placeholder="Ø¯ÙØ¹Ø© Ù…Ù† ÙƒØ§Ø´ Ø§Ù„Ù…Ø­Ù„"></div>
        <div class="col"><input type="number" id="p_from_shop_bank" placeholder="Ø¯ÙØ¹Ø© Ù…Ù† Ø¨Ù†Ùƒ Ø§Ù„Ù…Ø­Ù„"></div>
        <div class="col"><input type="number" id="p_from_owner_cash" placeholder="Ø¯ÙØ¹Ø© Ù…Ù† ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ"></div>
      </div>
      <input type="text" id="p_note" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø±Ù‚Ù… ÙØ§ØªÙˆØ±Ø©/ØªÙØ§ØµÙŠÙ„) â€” Ø§Ø®ØªÙŠØ§Ø±ÙŠ">
      <button class="btn btn-primary" onclick="purchaseFromTrader()">ğŸ§¾ ØªØ³Ø¬ÙŠÙ„ Ø´Ø±Ø§Ø¡</button>
      <div class="hint">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø¯ÙØ¹Ø§Øª ÙŠÙØ³Ø¬Ù„ Ø±ØµÙŠØ¯Ù‹Ø§ Ù„Ù„ØªØ§Ø¬Ø±. Ø¯ÙØ¹Ø§Øª Ø§Ù„Ù…Ø§Ù„Ùƒ ØªÙØ®ØµÙ… ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ù† ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ.</div>
    </div>

    <div class="subtle print-hide">
      <h4>Ø³Ø¯Ø§Ø¯ Ù„Ù„ØªØ§Ø¬Ø±</h4>
      <div class="row">
        <div class="col"><label>Ø§Ù„ØªØ§Ø¬Ø±</label><select id="pay_trader"></select></div>
        <div class="col">
          <select id="pay_source">
            <option value="shop_cash">Ù…Ù† ÙƒØ§Ø´ Ø§Ù„Ù…Ø­Ù„</option>
            <option value="shop_bank">Ù…Ù† Ø¨Ù†Ùƒ Ø§Ù„Ù…Ø­Ù„</option>
            <option value="owner_cash">Ù…Ù† ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div class="col"><input type="number" id="pay_amount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº"></div>
        <div class="col"><input type="text" id="pay_note" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></div>
      </div>
      <button class="btn btn-outline" onclick="payTrader()">ğŸ’¸ ØªØ³Ø¬ÙŠÙ„ Ø³Ø¯Ø§Ø¯</button>
    </div>

    <div class="subtle">
      <h4>ÙƒØ´Ù Ø­Ø³Ø§Ø¨ ØªØ§Ø¬Ø±</h4>
      <div class="row print-hide">
        <div class="col"><label>Ø§Ù„ØªØ§Ø¬Ø±</label><select id="s_trader"></select></div>
        <div class="col"><label>Ù…Ù†</label><input type="date" id="ts_from"></div>
        <div class="col"><label>Ø¥Ù„Ù‰</label><input type="date" id="ts_to"></div>
        <div class="col">
          <label>&nbsp;</label>
          <button class="btn btn-primary" onclick="openTraderStatement()">Ø¹Ø±Ø¶ Ø§Ù„ÙƒØ´Ù / Ø·Ø¨Ø§Ø¹Ø©</button>
        </div>
      </div>
      <div class="hint">Ø§Ù„ÙƒØ´Ù ÙŠÙÙØªØ­ ÙÙŠ Ù†Ø§ÙØ°Ø© Ù…Ù†ÙØµÙ„Ø© Ø­ØªÙ‰ Ù„Ø§ ÙŠØ£Ø®Ø° Ø­ÙŠØ²Ù‹Ø§ Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©.</div>
    </div>

    <div class="subtle">
      <h4>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ¬Ø§Ø± ÙˆØ£Ø±ØµØ¯ØªÙ‡Ù…</h4>
      <div id="tradersList"></div>
    </div>
  </section>

  <!-- Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ -->
  <section class="card" data-tab="daily">
    <h3>Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ</h3>
    <div class="row print-hide">
      <div class="col"><label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="date" id="r_date"></div>
      <div class="col"><label>Ø§Ù„Ù…Ø­Ù„</label>
        <select id="r_store">
          <option value="store1">Ø±ÙˆØ§Ù† Ø¨ÙŠØ¨ÙŠ</option>
          <option value="store2">Ø¬Ù†ØªÙ„ Ø¨ÙŠØ¨ÙŠ Ø¹Ø¨ÙˆØ¯</option>
          <option value="store3">Ø¨Ø³Ø·Ø©</option>
        </select>
      </div>
      <div class="col"><label>&nbsp;</label><button class="btn btn-primary" onclick="generateDaily()">Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button></div>
      <div class="col"><label>&nbsp;</label><button class="btn btn-outline" onclick="printSection('dailyWrap')">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© PDF</button></div>
    </div>
    <div id="dailyWrap"></div>
  </section>

  <!-- ØªÙ‚Ø±ÙŠØ± ÙØªØ±Ø© / Ù…Ø¬Ù…Ù‘Ø¹ + ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ -->
  <section class="card" data-tab="range">
    <h3>ØªÙ‚Ø±ÙŠØ± ÙØªØ±Ø© / Ù…Ø¬Ù…Ù‘Ø¹</h3>
    <div class="row print-hide">
      <div class="col"><label>Ù…Ù†</label><input type="date" id="f_from"></div>
      <div class="col"><label>Ø¥Ù„Ù‰</label><input type="date" id="f_to"></div>
      <div class="col"><label>Ø§Ù„Ù†Ù…Ø·</label>
        <select id="f_mode">
          <option value="per">Ù…Ù†ÙØµÙ„ Ù„ÙƒÙ„ Ù…Ø­Ù„</option>
          <option value="all">Ù…Ø¬Ù…Ù‘Ø¹ Ù„Ù„Ù…Ø­Ù„Ø§Øª Ø§Ù„Ø«Ù„Ø§Ø«Ø©</option>
        </select>
      </div>
      <div class="col"><label>&nbsp;</label><button class="btn btn-primary" onclick="generateRange()">Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button></div>
      <div class="col"><label>&nbsp;</label><button class="btn btn-outline" onclick="printSection('rangeWrap')">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© PDF</button></div>
    </div>
    <div id="rangeWrap"></div>
  </section>

  <!-- ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ: ØªØ¨ÙˆÙŠØ¨ Ù…Ø³ØªÙ‚Ù„ -->
  <section class="card" data-tab="owner">
    <h3>ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ â€” ÙƒØ´Ù ÙÙˆØ±ÙŠ</h3>
    <div class="row print-hide">
      <div class="col"><label>Ù…Ù†</label><input type="date" id="of_from"></div>
      <div class="col"><label>Ø¥Ù„Ù‰</label><input type="date" id="of_to"></div>
      <div class="col"><label>&nbsp;</label><button class="btn btn-primary" onclick="renderOwnerStatement()">Ø¹Ø±Ø¶ Ø§Ù„ÙƒØ´Ù</button></div>
      <div class="col"><label>&nbsp;</label><button class="btn btn-outline" onclick="printSection('ownerWrap')">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© PDF</button></div>
    </div>
    <div id="ownerWrap"></div>

    <div class="subtle print-hide" style="margin-top:12px">
      <h4>ØµÙŠØ§Ù†Ø© Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ (Ù„Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø§Ù„Ù‚Ø©)</h4>
      <div class="row">
        <div class="col"><label>Ù…Ù†</label><input type="date" id="maint_from"></div>
        <div class="col"><label>Ø¥Ù„Ù‰</label><input type="date" id="maint_to"></div>
      </div>
      <div class="row">
        <div class="col"><button class="btn btn-danger" onclick="removeSettlementsInRange()">ğŸ—‘ï¸ Ø­Ø°Ù ØªØ³ÙˆÙŠØ§Øª Ø§Ù„ÙØªØ±Ø©</button></div>
        <div class="col"><button class="btn btn-primary" onclick="recomputeSettlementsInRange()">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ø­ØªØ³Ø§Ø¨ ØªØ³ÙˆÙŠØ§Øª Ø§Ù„ÙØªØ±Ø©</button></div>
      </div>
      <div class="hint">Ø§Ù„Ø­Ø°Ù/Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§Ø­ØªØ³Ø§Ø¨ ØªØ´Ù…Ù„ ÙÙ‚Ø· Ø§Ù„ØªØ³ÙˆÙŠØ§Øª Ø§Ù„Ø¢Ù„ÙŠØ© (ØªØ±Ø­ÙŠÙ„ ÙƒØ§Ø´ Ø§Ù„ÙŠÙˆÙ…)ØŒ ÙˆÙ„Ø§ ØªÙ…Ø³Ù‘ Ø§Ù„Ø­Ø±ÙƒØ§Øª Ø§Ù„ÙŠØ¯ÙˆÙŠØ© Ø£Ùˆ Ø¯ÙØ¹Ø§Øª Ø§Ù„ØªØ¬Ø§Ø± ÙˆØ§Ù„Ø³Ù„Ù.</div>
    </div>
  </section>
</main>

<nav class="tabs print-hide">
  <div class="tab active"><button onclick="showTab('input')">Ø¥Ø¯Ø®Ø§Ù„</button></div>
  <div class="tab"><button onclick="showTab('daily')">ÙŠÙˆÙ…ÙŠ</button></div>
  <div class="tab"><button onclick="showTab('range')">ÙØªØ±Ø©/Ù…Ø¬Ù…Ù‘Ø¹</button></div>
  <div class="tab"><button onclick="showTab('loans')">Ø§Ù„Ø³ÙÙ„Ù</button></div>
  <div class="tab"><button onclick="showTab('traders')">Ø§Ù„ØªØ¬Ø§Ø±</button></div>
  <div class="tab"><button onclick="showTab('owner')">Ø§Ù„Ù…Ø§Ù„Ùƒ</button></div>
</nav>

<script>
// ===== Helpers & Storage =====
const stores={store1:"Ø±ÙˆØ§Ù† Ø¨ÙŠØ¨ÙŠ",store2:"Ø¬Ù†ØªÙ„ Ø¨ÙŠØ¨ÙŠ Ø¹Ø¨ÙˆØ¯",store3:"Ø¨Ø³Ø·Ø©"};let currentStore="store1";
const qs=(s)=>document.querySelector(s);
function todayISO(){return new Date().toISOString().slice(0,10)}
function fmtDatePretty(iso){const d=new Date(iso+"T00:00:00");const days=["Ø§Ù„Ø£Ø­Ø¯","Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†","Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡","Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡","Ø§Ù„Ø®Ù…ÙŠØ³","Ø§Ù„Ø¬Ù…Ø¹Ø©","Ø§Ù„Ø³Ø¨Øª"];const dd=String(d.getDate()).padStart(2,"0");const mm=String(d.getMonth()+1).padStart(2,"0");const yyyy=d.getFullYear();return `${days[d.getDay()]} ${yyyy}-${mm}-${dd}`}
function uid(){return Date.now().toString(36)+Math.random().toString(36).slice(2,7)}

function getData(store=currentStore){return JSON.parse(localStorage.getItem(store)||'{"sales":[],"expenses":[]}')}
function saveData(store=currentStore,data){localStorage.setItem(store,JSON.stringify(data))}

// Owner fund
function getOwner(){return JSON.parse(localStorage.getItem('owner_fund')||'{"ledger":[]}')}
function saveOwner(v){localStorage.setItem('owner_fund',JSON.stringify(v))}
function ownerIn(amount,note,meta){const O=getOwner();O.ledger.push({id:uid(),date:todayISO(),type:'in',amount:+amount,note,meta:meta||{}});saveOwner(O);updateOwnerBalanceUI()}
function ownerOut(amount,note,meta){const O=getOwner();O.ledger.push({id:uid(),date:todayISO(),type:'out',amount:+amount,note,meta:meta||{}});saveOwner(O);updateOwnerBalanceUI()}

// Loans (Ø³ÙÙ„Ù)
function getLoans(){return JSON.parse(localStorage.getItem('loans')||'{"list":[]}')}
function saveLoans(v){localStorage.setItem('loans',JSON.stringify(v))}
function refreshLoanSelects(){const v=getLoans().list;['loan_person','repay_person','exp_lender'].forEach(id=>{const sel=qs('#'+id);if(!sel)return;sel.innerHTML=v.length?v.map(o=>`<option value="${o.id}">${o.name}</option>`).join(''):'<option value="">â€” Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³Ù„ÙÙˆÙ† â€”</option>';})}
function renderLendersList(){const v=getLoans().list;const wrap=qs('#lendersList');if(!wrap)return;if(!v.length){wrap.innerHTML='<div class="hint">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙØ³Ù„ÙÙˆÙ†</div>';return}wrap.innerHTML=v.map(L=>{const adv=L.advanced||0,used=L.used||0,rep=L.repaid||0;const stillOnUs=adv-rep;const remain=Math.max(0,adv-used);return `<div class="item"><div class="meta"><b>${L.name}</b> ${L.phone?('â€” '+L.phone):''}<div class="hint">Ø¹Ù„ÙŠÙ†Ø§ Ø§Ù„Ø¢Ù†: <b>${stillOnUs}</b> â€” ØºÙŠØ± Ù…Ø³ØªØ®Ø¯Ù…: <b>${remain}</b></div></div><div><button class="btn btn-danger" onclick="deleteLender('${L.id}')">Ø­Ø°Ù</button></div></div>`}).join('')}
function addLender(){const name=(qs('#l_name').value||'').trim();const phone=(qs('#l_phone').value||'').trim();if(!name){alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…ÙØ³Ù„Ù');return}const D=getLoans();D.list.push({id:uid(),name,phone,ledger:[],advanced:0,used:0,repaid:0});saveLoans(D);qs('#l_name').value='';qs('#l_phone').value='';renderLoansUI()}
function deleteLender(id){const D=getLoans();const i=D.list.findIndex(x=>x.id===id);if(i>-1&&confirm('Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ÙØ³Ù„Ù ÙˆÙƒØ§ÙØ© Ø­Ø±ÙƒØ§ØªÙ‡ØŸ')){D.list.splice(i,1);saveLoans(D);renderLoansUI()}}
function deleteLenderEntry(lid,eid){const D=getLoans();const L=D.list.find(x=>x.id===lid);if(!L)return;const i=(L.ledger||[]).findIndex(x=>x.id===eid);if(i>-1&&confirm('Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø±ÙƒØ©ØŸ')){L.ledger.splice(i,1);recomputeLender(L);saveLoans(D);renderLoansUI()}}
function recomputeLender(L){let adv=0,used=0,rep=0;(L.ledger||[]).forEach(e=>{if(e.type==='advance')adv+=(+e.amount||0);else if(e.type==='use')used+=(+e.amount||0);else if(e.type==='repay')rep+=(+e.amount||0)});L.advanced=adv;L.used=used;L.repaid=rep}
function takeLoan(){const id=(qs('#loan_person')||{}).value;const amt=parseFloat((qs('#loan_amount').value||'0'));const note=(qs('#loan_note').value||'').trim();if(!id||!amt){alert('Ø§Ø®ØªØ± Ù…ÙØ³Ù„Ù ÙˆØ£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº');return}const D=getLoans();const L=D.list.find(x=>x.id===id);(L.ledger||(L.ledger=[])).push({id:uid(),type:'advance',date:todayISO(),amount:amt,note});recomputeLender(L);saveLoans(D);qs('#loan_amount').value='';qs('#loan_note').value='';renderLoansUI();alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø³Ù„ÙØ©.')} 
function repayLoan(){const id=(qs('#repay_person')||{}).value;const amt=parseFloat((qs('#repay_amount').value||'0'));const note=(qs('#repay_note').value||'').trim();const src=(qs('#repay_source')||{}).value||'shop_cash';if(!id||!amt){alert('Ø§Ø®ØªØ± Ù…ÙØ³Ù„Ù ÙˆØ£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº');return}const D=getLoans();const L=D.list.find(x=>x.id===id);(L.ledger||(L.ledger=[])).push({id:uid(),type:'repay',date:todayISO(),amount:amt,note,source:src});recomputeLender(L);saveLoans(D);
// Ø³Ø¬Ù„ Ø§Ù„Ù…ØµØ¯Ø±
if(src==='shop_cash'){const d=getData();d.expenses.push({id:uid(),date:todayISO(),type:'ÙƒØ§Ø´',desc:`Ø³Ø¯Ø§Ø¯ Ø³Ù„ÙØ© (${L.name})`,amount:amt,note:note||'Ù…Ù† ÙƒØ§Ø´ Ø§Ù„Ù…Ø­Ù„'});saveData(currentStore,d)}
if(src==='owner_cash'){ownerOut(amt, `Ø³Ø¯Ø§Ø¯ Ø³Ù„ÙØ© (${L.name}) â€” ${note||''}`, {kind:'loan_repay', lenderId:id})}
qs('#repay_amount').value='';qs('#repay_note').value='';renderLoansUI();updateOwnerBalanceUI();alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø³Ø¯Ø§Ø¯.')} 
function renderLoansUI(){refreshLoanSelects();renderLendersList()}

// Sales & Expenses
function changeStore(){currentStore=qs('#storeSelect').value;renderLists()}
function addSale(){const a=parseFloat((qs('#saleAmount').value||'0'));const t=qs('#saleType').value;const n=(qs('#saleNote').value||'').trim();if(!a){alert('Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­');return}const d=getData();d.sales.push({id:uid(),date:todayISO(),type:t,amount:a,note:n});saveData(currentStore,d);qs('#saleAmount').value='';qs('#saleNote').value='';renderLists()}
function toggleExpenseTarget(){const val=qs('#expenseTarget').value;qs('#expLenderRow').style.display=(val==='lender')?'flex':'none';qs('#expTraderRow').style.display=(val==='trader')?'flex':'none'}
function addExpense(){const desc=(qs('#expenseDesc').value||'').trim();const a=parseFloat((qs('#expenseAmount').value||'0'));const t=qs('#expenseType').value;const target=qs('#expenseTarget').value;const n=(qs('#expenseNote').value||'').trim();if(!desc||!a){alert('Ø£Ø¯Ø®Ù„ ÙˆØµÙ ÙˆÙ…Ø¨Ù„Øº ØµØ­ÙŠØ­');return}const d=getData();d.expenses.push({id:uid(),date:todayISO(),type:t,desc:desc,amount:a,note:n});saveData(currentStore,d);
// Ø³Ø¯Ø§Ø¯ Ù„Ù…Ø³Ù„Ù Ù…Ù† Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ
if(target==='lender'){const lid=(qs('#exp_lender')||{}).value;const src=(qs('#exp_lender_source')||{}).value||'shop_cash';const D=getLoans();const L=D.list.find(x=>x.id===lid);if(L){(L.ledger||(L.ledger=[])).push({id:uid(),type:'repay',date:todayISO(),amount:a,note:desc+' â€” '+n,source:src});recomputeLender(L);saveLoans(D);if(src==='owner_cash'){ownerOut(a, `Ø³Ø¯Ø§Ø¯ Ø³Ù„ÙØ© (${L.name}) Ø¹Ø¨Ø± Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ â€” ${desc}`, {kind:'loan_repay', lenderId:lid})}}}
// Ø³Ø¯Ø§Ø¯ Ù„ØªØ§Ø¬Ø± Ø¹Ø¨Ø± Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ
if(target==='trader'){const tid=(qs('#exp_trader')||{}).value;const T=getTraders();const tr=T.list.find(x=>x.id===tid);if(tr){let sc=0,sb=0,oc=0;if(t==='ÙƒØ§Ø´')sc=a;else if(t==='Ø¨Ù†Ùƒ')sb=a;(tr.ledger||(tr.ledger=[])).push({id:uid(),type:'payment',date:todayISO(),amount:a,pay_shop_cash:sc,pay_shop_bank:sb,pay_owner_cash:oc,note:desc+' â€” '+n});recomputeTrader(tr);saveTraders(T);}}
qs('#expenseDesc').value='';qs('#expenseAmount').value='';qs('#expenseNote').value='';renderLists();updateOwnerBalanceUI()}
function deleteSale(id){const d=getData();const i=d.sales.findIndex(x=>x.id===id);if(i>-1&&confirm('Ø­Ø°Ù Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¨ÙŠØ¹ØŸ')){d.sales.splice(i,1);saveData(currentStore,d);renderLists()}}
function deleteExpense(id){const d=getData();const i=d.expenses.findIndex(x=>x.id===id);if(i>-1&&confirm('Ø­Ø°Ù Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù…ØµØ±ÙˆÙØŸ')){d.expenses.splice(i,1);saveData(currentStore,d);renderLists()}}
function renderLists(){const d=getData();const rs=d.sales.slice(-20).reverse();const re=d.expenses.slice(-20).reverse();const rsHtml=rs.map(v=>`<div class="item"><div class="meta">${v.date} â€” <span class="tag">${v.type}</span> ${v.note?('â€” <i>'+v.note+'</i>'):''}</div><div><b>${v.amount}</b></div><div><button class="btn btn-danger" onclick="deleteSale('${v.id}')">Ø­Ø°Ù</button></div></div>`).join('')||'<div class="hint">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨ÙŠØ¹Ø§Øª Ø¨Ø¹Ø¯</div>';const reHtml=re.map(v=>`<div class="item"><div class="meta">${v.date} â€” <span class="tag">${v.type}</span> â€” ${v.desc} ${v.note?('â€” <i>'+v.note+'</i>'):''}</div><div><b>${v.amount}</b></div><div><button class="btn btn-danger" onclick="deleteExpense('${v.id}')">Ø­Ø°Ù</button></div></div>`).join('')||'<div class="hint">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ§Ø±ÙŠÙ Ø¨Ø¹Ø¯</div>';qs('#recentSales').innerHTML=rsHtml;qs('#recentExpenses').innerHTML=reHtml}

// Traders data
function getTraders(){return JSON.parse(localStorage.getItem('traders')||'{"list":[]}')}
function saveTraders(v){localStorage.setItem('traders',JSON.stringify(v))}
function refreshTraderSelects(){const v=getTraders().list;['p_trader','pay_trader','s_trader','exp_trader'].forEach(id=>{const sel=qs('#'+id);if(!sel)return;sel.innerHTML=v.length?v.map(o=>`<option value="${o.id}">${o.name}</option>`).join(''):'<option value="">â€” Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ¬Ø§Ø± â€”</option>';})}
function addTrader(){const name=(qs('#t_name').value||'').trim();const phone=(qs('#t_phone').value||'').trim();if(!name){alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„ØªØ§Ø¬Ø±');return}const T=getTraders();T.list.push({id:uid(),name,phone,balance:0,ledger:[]});saveTraders(T);qs('#t_name').value='';qs('#t_phone').value='';renderTradersUI()}
function deleteTrader(id){const T=getTraders();const i=T.list.findIndex(x=>x.id===id);if(i>-1&&confirm('Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØªØ§Ø¬Ø± Ù…Ø¹ ÙƒÙ„ Ø­Ø±ÙƒØ§ØªÙ‡ØŸ')){T.list.splice(i,1);saveTraders(T);renderTradersUI()}}
function deleteTraderEntry(tid,eid){const T=getTraders();const t=T.list.find(x=>x.id===tid);if(!t)return;const i=(t.ledger||[]).findIndex(x=>x.id===eid);if(i>-1&&confirm('Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø±ÙƒØ©ØŸ')){t.ledger.splice(i,1);recomputeTrader(t);saveTraders(T);renderTradersUI()}}
function recomputeTrader(t){let bal=0;(t.ledger||[]).forEach(e=>{if(e.type==='purchase'){const remain=(+e.amount||0)-((+e.pay_shop_cash||0)+(+e.pay_shop_bank||0)+(+e.pay_owner_cash||0));bal+=remain}else if(e.type==='payment'){bal-= (+e.amount||0); if(bal<0) bal=0}e.balance_after=bal});t.balance=bal}
function renderTradersUI(){refreshTraderSelects();renderTradersList()}
function renderTradersList(){const v=getTraders().list;const wrap=qs('#tradersList');if(!wrap)return;wrap.innerHTML=v.length?v.map(o=>`<div class="item"><div class="meta"><b>${o.name}</b> ${o.phone?('â€” '+o.phone):''} <span class="hint">| Ø§Ù„Ø±ØµÙŠØ¯: ${o.balance||0}</span></div><div><button class="btn btn-danger" onclick="deleteTrader('${o.id}')">Ø­Ø°Ù</button></div></div>`).join(''):'<div class="hint">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ¬Ø§Ø±</div>'}

// Owner Statement tab
function renderOwnerStatement(){
  const from=(qs('#of_from')||{}).value || todayISO().slice(0,8)+'01';
  const to  =(qs('#of_to')||{}).value   || todayISO();
  const O=getOwner();
  const rows=(O.ledger||[]).filter(x=>inRange(x.date,from,to));
  const inSum=rows.filter(x=>x.type==='in').reduce((a,b)=>a+(+b.amount||0),0);
  const outSum=rows.filter(x=>x.type==='out').reduce((a,b)=>a+(+b.amount||0),0);
  const bal=inSum-outSum;
  const tableRows=rows.length?rows.map(e=>`
    <tr>
      <td>${e.date}</td>
      <td>${e.type==='in'?'ØªØ­ØµÙŠÙ„':'ØµØ±Ù'}</td>
      <td>${e.amount}</td>
      <td>${e.note||''}</td>
    </tr>`).join(''):`<tr><td colspan="4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø±ÙƒØ§Øª Ø¶Ù…Ù† Ø§Ù„ÙØªØ±Ø©</td></tr>`;
  qs('#ownerWrap').innerHTML = `
    <div class="page">
      <h2 style="margin:0 0 8px">ÙƒØ´Ù ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ</h2>
      <div class="hint">Ø§Ù„ÙØªØ±Ø©: <b>${from}</b> â†’ <b>${to}</b> â€” ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: <b>${fmtDatePretty(todayISO())}</b></div>
      <div class="separator"></div>
      <table>
        <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</th></tr></thead>
        <tbody>${tableRows}</tbody>
      </table>
      <div style="margin-top:10px">
        <span class="badge">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªØ­ØµÙŠÙ„: <b>${inSum}</b></span>
        <span class="badge" style="margin-inline:6px">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØµØ±Ù: <b>${outSum}</b></span>
        <span class="badge">Ø§Ù„Ø±ØµÙŠØ¯ Ù„Ù„ÙØªØ±Ø©: <b>${bal}</b></span>
      </div>
      <div style="margin-top:40px;display:flex;justify-content:space-between">
        <div>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø§Ù„Ùƒ: Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡ Ø£Ø¨Ùˆ Ø¹ÙˆØ¶ ____________________</div>
        <div>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠ: ____________________</div>
      </div>
    </div>`;
}

// Maintenance helpers
function inRange(iso,from,to){const d=new Date(iso+"T00:00:00");return d>=new Date(from+"T00:00:00")&&d<=new Date(to+"T00:00:00")}
function dateAddDays(iso,days){const d=new Date(iso+"T00:00:00");d.setDate(d.getDate()+days);return d.toISOString().slice(0,10)}
function eachDate(from,to,fn){let cur=from;while(cur<=to){fn(cur);cur=dateAddDays(cur,1)}}

function removeSettlementsInRange(){
  const from=(qs('#maint_from')||{}).value || todayISO().slice(0,8)+'01';
  const to  =(qs('#maint_to')||{}).value   || todayISO();
  const O=getOwner();
  for(let i=(O.ledger||[]).length-1;i>=0;i--){
    const e=O.ledger[i], meta=e.meta||{};
    const isSettle=(meta.kind==='settle') || (typeof e.note==='string' && e.note.indexOf('ØªØ±Ø­ÙŠÙ„ ÙƒØ§Ø´ Ø§Ù„ÙŠÙˆÙ… Ù…Ù†')===0);
    if(isSettle && inRange(e.date,from,to)){ O.ledger.splice(i,1); }
  }
  saveOwner(O); updateOwnerBalanceUI(); renderOwnerStatement(); alert('ØªÙ… Ø­Ø°Ù ØªØ³ÙˆÙŠØ§Øª Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ù…Ù† ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ.');
}

function recomputeSettlementsInRange(){
  const from=(qs('#maint_from')||{}).value || todayISO().slice(0,8)+'01';
  const to  =(qs('#maint_to')||{}).value   || todayISO();
  // Ø£ÙˆÙ„Ø§Ù‹: Ø§Ø­Ø°Ù Ø§Ù„ØªØ³ÙˆÙŠØ§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¶Ù…Ù† Ø§Ù„ÙØªØ±Ø©
  const O=getOwner();
  for(let i=(O.ledger||[]).length-1;i>=0;i--){
    const e=O.ledger[i], meta=e.meta||{};
    const isSettle=(meta.kind==='settle') || (typeof e.note==='string' && e.note.indexOf('ØªØ±Ø­ÙŠÙ„ ÙƒØ§Ø´ Ø§Ù„ÙŠÙˆÙ… Ù…Ù†')===0);
    if(isSettle && inRange(e.date,from,to)){ O.ledger.splice(i,1); }
  }
  saveOwner(O);
  // Ø«Ù…: Ø£Ø¹Ø¯ Ø§Ø­ØªØ³Ø§Ø¨ ØªØ³ÙˆÙŠØ© ÙƒÙ„ ÙŠÙˆÙ… Ù„ÙƒÙ„ Ù…Ø­Ù„
  const shops=Object.keys(stores);
  eachDate(from,to,(day)=>{
    shops.forEach(storeKey=>{
      const d=JSON.parse(localStorage.getItem(storeKey)||'{"sales":[],"expenses":[]}');
      const cashSales=(d.sales||[]).filter(x=>x.date===day && x.type==='ÙƒØ§Ø´').reduce((a,b)=>a+(+b.amount||0),0);
      const cashExp  =(d.expenses||[]).filter(x=>x.date===day && x.type==='ÙƒØ§Ø´').reduce((a,b)=>a+(+b.amount||0),0);
      const net=cashSales-cashExp;
      if(net>0){
        const O2=getOwner();
        (O2.ledger||[]).push({id:uid(),date:day,type:'in',amount:+net,
          note:`ØªØ±Ø­ÙŠÙ„ ÙƒØ§Ø´ Ø§Ù„ÙŠÙˆÙ… Ù…Ù† ${stores[storeKey]}`,
          meta:{kind:'settle', store:storeKey, date_ref:day}});
        saveOwner(O2);
      }
    });
  });
  updateOwnerBalanceUI(); renderOwnerStatement(); alert('ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„ØªØ³ÙˆÙŠØ§Øª Ù„Ù„ÙØªØ±Ø©.');
}

// Print
function printSection(id){const el=document.getElementById(id);if(!el||!el.innerHTML.trim()){alert('Ø§Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø£ÙˆÙ„Ø§Ù‹');return}const w=window.open('','_blank');const css=document.querySelector('style').outerHTML;const h=`<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="utf-8"/><title>Ø·Ø¨Ø§Ø¹Ø©</title>${css}</head><body>${el.innerHTML}</body></html>`;w.document.write(h);w.document.close();w.focus();w.print()}

// Owner balance UI
function updateOwnerBalanceUI(){
  const O=getOwner();
  const inSum=(O.ledger||[]).filter(x=>x.type==='in').reduce((a,b)=>a+(+b.amount||0),0);
  const outSum=(O.ledger||[]).filter(x=>x.type==='out').reduce((a,b)=>a+(+b.amount||0),0);
  const bal=inSum-outSum;
  const el=qs('#ownerBalanceVal'); if(el) el.textContent=bal;
  return bal;
}

// ===== Idempotent Settlement (per store, per day) =====
function upsertOwnerSettlement(storeKey, dateISO, amount){
  const O=getOwner();
  for(let i=(O.ledger||[]).length-1;i>=0;i--){
    const e=O.ledger[i];
    const meta=e.meta||{};
    const isSettleByMeta = meta && meta.kind==='settle' && meta.store===storeKey && meta.date_ref===dateISO;
    const isSettleByNote = typeof e.note==='string' && e.note.indexOf('ØªØ±Ø­ÙŠÙ„ ÙƒØ§Ø´ Ø§Ù„ÙŠÙˆÙ… Ù…Ù†')===0 && e.note.indexOf(stores[storeKey])>-1 && e.date===dateISO && e.type==='in';
    if(isSettleByMeta || isSettleByNote){ O.ledger.splice(i,1); }
  }
  if(amount>0){
    (O.ledger||[]).push({id:uid(),date:dateISO,type:'in',amount:+amount,
      note:`ØªØ±Ø­ÙŠÙ„ ÙƒØ§Ø´ Ø§Ù„ÙŠÙˆÙ… Ù…Ù† ${stores[storeKey]}`,
      meta:{kind:'settle', store:storeKey, date_ref:dateISO}});
  }
  saveOwner(O);
  updateOwnerBalanceUI();
}

function settleDay(){
  const input=qs('#todayInput'); const today = (input && input.value) ? input.value : todayISO();
  const d=getData();
  const cashSales=d.sales.filter(x=>x.date===today && x.type==='ÙƒØ§Ø´').reduce((a,b)=>a+(+b.amount||0),0);
  const cashExp  =d.expenses.filter(x=>x.date===today && x.type==='ÙƒØ§Ø´').reduce((a,b)=>a+(+b.amount||0),0);
  const net=cashSales-cashExp;
  if(net<=0){
    upsertOwnerSettlement(currentStore, today, 0);
    alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙƒØ§Ø´ ÙØ§Ø¦Ø¶ Ù„Ù„ØªØ±Ø­ÙŠÙ„ (ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ ØªØ³ÙˆÙŠØ© Ø³Ø§Ø¨Ù‚Ø© Ù„Ù„ÙŠÙˆÙ… Ø¥Ù† ÙˆÙØ¬Ø¯Øª).');
    return;
  }
  upsertOwnerSettlement(currentStore, today, net);
  alert(`ØªÙ… ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ³ÙˆÙŠØ© Ù„Ù„ÙŠÙˆÙ… Ø¨Ù…Ø¨Ù„Øº ${net} (ØªØ³ÙˆÙŠØ© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· Ù„Ù„ÙŠÙˆÙ…).`);
}

// Tabs & boot
function showTab(name){document.querySelectorAll('[data-tab]').forEach(s=>s.style.display=(s.getAttribute('data-tab')===name)?'block':'none');const order=['input','daily','range','loans','traders','owner'];document.querySelectorAll('.tabs .tab').forEach((t,i)=>t.classList.toggle('active',order[i]===name));if(name==='input')renderLists();if(name==='loans')renderLoansUI();if(name==='traders')renderTradersUI();if(name==='owner')renderOwnerStatement()}
function initDates(){const t=todayISO();['todayInput','r_date','maint_from','of_from','f_from','ts_from'].forEach(id=>{const x=qs('#'+id);if(x)x.value=t.slice(0,8)+'01'});['maint_to','of_to','f_to','ts_to'].forEach(id=>{const x=qs('#'+id);if(x)x.value=t})}
document.addEventListener('DOMContentLoaded',()=>{initDates();showTab('input');renderLists();refreshLoanSelects();refreshTraderSelects();updateOwnerBalanceUI()});
</script>
</body>
</html>
