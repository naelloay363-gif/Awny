<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>اصدار تسوية ذكية — نظام محاسبة محلي</title>
<style>
:root{--blue:#2878ff;--blue-2:#eaf1ff;--text:#0f172a;--muted:#64748b;--danger:#dc3545;--ok:#16a34a;--card:#ffffff;--line:#e5e7eb}
*{box-sizing:border-box}html,body{height:100%}body{margin:0;font-family:Tahoma, Arial, sans-serif;background:var(--blue-2);color:var(--text)}
header{position:sticky;top:0;z-index:10;background:var(--blue);color:#fff;padding:10px 14px;box-shadow:0 2px 10px rgba(0,0,0,.08)}
header h1{margin:0;font-size:18px}header .sub{opacity:.95;font-size:13px}
header .owner-badge{margin-top:6px;font-size:14px;color:#eaf5ff;background:rgba(255,255,255,.12);display:inline-block;padding:6px 10px;border-radius:10px}
main{padding:12px;max-width:1100px;margin:auto;padding-bottom:160px}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;margin:10px 0;box-shadow:0 1px 6px rgba(0,0,0,.04)}
h3{margin:6px 0 10px}
.row{display:flex;flex-wrap:wrap;gap:10px}.col{flex:1;min-width:200px}label{font-size:13px;color:#111}
input,select,textarea,button{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:12px;font-size:16px;background:#fff}
textarea{min-height:70px;resize:vertical}button{border:none;cursor:pointer}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;border-radius:12px;padding:10px 14px;font-size:14px}
.btn-primary{background:var(--blue);color:#fff}.btn-outline{background:#fff;border:1px solid var(--line);color:#111}
.btn-danger{background:var(--danger);color:#fff}.btn-ok{background:var(--ok);color:#fff}
.hint{font-size:12px;color:var(--muted)}
.list .item{display:flex;justify-content:space-between;align-items:center;gap:10px;padding:8px 0;border-bottom:1px dashed var(--line)}
.list .item:last-child{border-bottom:none}.list .meta{flex:1}
.kpi{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}.kpi .box{background:#f3f7ff;border:1px solid #e3ecff;border-radius:12px;padding:10px;text-align:center}.kpi .box b{display:block;font-size:16px}
table{width:100%;border-collapse:collapse;margin-top:10px}th,td{border:1px solid var(--line);padding:8px;text-align:center;font-size:14px}th{background:#f8fbff}
.tabs{position:fixed;bottom:0;left:0;right:0;background:#fff;border-top:1px solid var(--line);display:flex}
.tab{flex:1}.tab button{width:100%;background:#fff;border:none;padding:12px 0}.tab.active{background:#f6f8ff}
.tag{display:inline-block;padding:.2rem .5rem;border-radius:999px;background:#eef2ff;border:1px solid #e5e7eb;font-size:12px}
.subtle{background:#f9fbff;border:1px solid #eef2ff;border-radius:12px;padding:10px;margin-top:8px}
.separator{height:1px;background:var(--line);margin:8px 0}.print-hide{}
.badge{display:inline-block;padding:.25rem .6rem;border-radius:999px;border:1px solid #dbeafe;background:#eff6ff;font-size:12px}
@media print{header,nav.tabs,.print-hide{display:none !important}body{background:#fff}.card{box-shadow:none;border:none;padding:0;margin:0}.page{page-break-after:always;margin-bottom:30px}}
</style>
</head>
<body>
<header class="print-hide">
  <h1>نظام محاسبة محلي</h1>
  <div class="sub">المالك: <b>عبد الله أبو عوض</b></div>
  <div class="owner-badge">رصيد صندوق المالك: <b id="ownerBalanceVal">0</b></div>
</header>

<main>
  <div class="card print-hide">
    <div class="row">
      <div class="col">
        <label>المحل</label>
        <select id="storeSelect" onchange="changeStore()">
          <option value="store1">روان بيبي</option>
          <option value="store2">جنتل بيبي عبود</option>
          <option value="store3">بسطة</option>
        </select>
      </div>
      <div class="col">
        <label>تاريخ اليوم</label>
        <input type="date" id="todayInput"/>
      </div>
      <div class="col">
        <label>&nbsp;</label>
        <button class="btn btn-primary" onclick="settleDay()">تسوية اليوم لصندوق المالك</button>
      </div>
    </div>
    <div class="hint">كل البيانات محفوظة محليًا على هذا الجهاز، وتعمل بدون إنترنت.</div>
  </div>

  <!-- إدخال -->
  <section class="card" data-tab="input">
    <h3>تسجيل المبيعات</h3>
    <div class="row">
      <div class="col"><input type="number" id="saleAmount" placeholder="المبلغ"></div>
      <div class="col">
        <select id="saleType">
          <option value="كاش">كاش</option>
          <option value="بنك">بنك</option>
        </select>
      </div>
      <div class="col"><input type="text" id="saleNote" placeholder="ملاحظات (اسم المشتري/الصنف/جوال)"></div>
    </div>
    <div class="row"><div class="col"><button class="btn btn-ok" onclick="addSale()">➕ إضافة بيع</button></div></div>
    <div class="list" id="recentSales"></div>

    <h3 style="margin-top:18px">تسجيل المصاريف</h3>
    <div class="row">
      <div class="col"><input type="text" id="expenseDesc" placeholder="وصف المصروف"></div>
      <div class="col"><input type="number" id="expenseAmount" placeholder="المبلغ"></div>
      <div class="col">
        <select id="expenseType">
          <option value="كاش">كاش</option>
          <option value="بنك">بنك</option>
        </select>
      </div>
      <div class="col">
        <select id="expenseTarget" onchange="toggleExpenseTarget()">
          <option value="normal">مصروف عادي</option>
          <option value="lender">سداد لمسلف</option>
          <option value="trader">سداد لتاجر</option>
        </select>
      </div>
    </div>
    <div class="row print-hide" id="expLenderRow" style="display:none">
      <div class="col"><label>المُسلف</label><select id="exp_lender"></select></div>
      <div class="col">
        <select id="exp_lender_source">
          <option value="shop_cash">من كاش المحل</option>
          <option value="owner_cash">من صندوق المالك</option>
        </select>
      </div>
    </div>
    <div class="row print-hide" id="expTraderRow" style="display:none">
      <div class="col"><label>التاجر</label><select id="exp_trader"></select></div>
    </div>
    <div class="row">
      <div class="col"><input type="text" id="expenseNote" placeholder="ملاحظات (اختياري)"></div>
    </div>
    <div class="row"><div class="col"><button class="btn btn-ok" onclick="addExpense()">➕ إضافة مصروف</button></div></div>
    <div class="list" id="recentExpenses"></div>
  </section>

  <!-- السُلف -->
  <section class="card" data-tab="loans">
    <h3>السُلف</h3>
    <div class="subtle print-hide">
      <h4>إضافة مُسلف</h4>
      <div class="row">
        <div class="col"><input type="text" id="l_name" placeholder="اسم المُسلف"></div>
        <div class="col"><input type="text" id="l_phone" placeholder="جوال (اختياري)"></div>
      </div>
      <button class="btn btn-ok" onclick="addLender()">➕ إضافة</button>
    </div>

    <div class="subtle print-hide">
      <h4>تسجيل سلفة جديدة (كاش)</h4>
      <div class="row">
        <div class="col"><label>المُسلف</label><select id="loan_person"></select></div>
        <div class="col"><input type="number" id="loan_amount" placeholder="المبلغ"></div>
      </div>
      <input type="text" id="loan_note" placeholder="ملاحظات (اختياري)">
      <button class="btn btn-primary" onclick="takeLoan()">💵 تسجيل سلفة</button>
    </div>

    <div class="subtle print-hide">
      <h4>سداد سلفة</h4>
      <div class="row">
        <div class="col"><label>المُسلف</label><select id="repay_person"></select></div>
        <div class="col"><input type="number" id="repay_amount" placeholder="المبلغ"></div>
        <div class="col">
          <select id="repay_source">
            <option value="shop_cash">من كاش المحل</option>
            <option value="owner_cash">من صندوق المالك</option>
          </select>
        </div>
      </div>
      <input type="text" id="repay_note" placeholder="ملاحظات (اختياري)">
      <button class="btn btn-outline" onclick="repayLoan()">↩️ تسجيل سداد</button>
    </div>

    <div class="subtle">
      <h4>قائمة المُسلفين وأرصدتهم</h4>
      <div id="lendersList"></div>
    </div>
  </section>

  <!-- التجار -->
  <section class="card" data-tab="traders">
    <h3>التجار</h3>
    <div class="subtle print-hide">
      <h4>إضافة تاجر</h4>
      <div class="row">
        <div class="col"><input type="text" id="t_name" placeholder="اسم التاجر"></div>
        <div class="col"><input type="text" id="t_phone" placeholder="جوال (اختياري)"></div>
      </div>
      <button class="btn btn-ok" onclick="addTrader()">➕ إضافة</button>
    </div>

    <div class="subtle print-hide">
      <h4>شراء من تاجر (فاتورة بضاعة)</h4>
      <div class="row">
        <div class="col"><label>التاجر</label><select id="p_trader"></select></div>
        <div class="col"><input type="number" id="p_total" placeholder="قيمة الفاتورة"></div>
      </div>
      <div class="row">
        <div class="col"><input type="number" id="p_from_shop_cash" placeholder="دفعة من كاش المحل"></div>
        <div class="col"><input type="number" id="p_from_shop_bank" placeholder="دفعة من بنك المحل"></div>
        <div class="col"><input type="number" id="p_from_owner_cash" placeholder="دفعة من صندوق المالك"></div>
      </div>
      <input type="text" id="p_note" placeholder="ملاحظات (رقم فاتورة/تفاصيل) — اختياري">
      <button class="btn btn-primary" onclick="purchaseFromTrader()">🧾 تسجيل شراء</button>
      <div class="hint">المتبقي بعد الدفعات يُسجل رصيدًا للتاجر. دفعات المالك تُخصم تلقائيًا من صندوق المالك.</div>
    </div>

    <div class="subtle print-hide">
      <h4>سداد للتاجر</h4>
      <div class="row">
        <div class="col"><label>التاجر</label><select id="pay_trader"></select></div>
        <div class="col">
          <select id="pay_source">
            <option value="shop_cash">من كاش المحل</option>
            <option value="shop_bank">من بنك المحل</option>
            <option value="owner_cash">من صندوق المالك</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div class="col"><input type="number" id="pay_amount" placeholder="المبلغ"></div>
        <div class="col"><input type="text" id="pay_note" placeholder="ملاحظات (اختياري)"></div>
      </div>
      <button class="btn btn-outline" onclick="payTrader()">💸 تسجيل سداد</button>
    </div>

    <div class="subtle">
      <h4>كشف حساب تاجر</h4>
      <div class="row print-hide">
        <div class="col"><label>التاجر</label><select id="s_trader"></select></div>
        <div class="col"><label>من</label><input type="date" id="ts_from"></div>
        <div class="col"><label>إلى</label><input type="date" id="ts_to"></div>
        <div class="col">
          <label>&nbsp;</label>
          <button class="btn btn-primary" onclick="openTraderStatement()">عرض الكشف / طباعة</button>
        </div>
      </div>
      <div class="hint">الكشف يُفتح في نافذة منفصلة حتى لا يأخذ حيزًا من الواجهة.</div>
    </div>

    <div class="subtle">
      <h4>قائمة التجار وأرصدتهم</h4>
      <div id="tradersList"></div>
    </div>
  </section>

  <!-- التقرير اليومي -->
  <section class="card" data-tab="daily">
    <h3>التقرير اليومي</h3>
    <div class="row print-hide">
      <div class="col"><label>التاريخ</label><input type="date" id="r_date"></div>
      <div class="col"><label>المحل</label>
        <select id="r_store">
          <option value="store1">روان بيبي</option>
          <option value="store2">جنتل بيبي عبود</option>
          <option value="store3">بسطة</option>
        </select>
      </div>
      <div class="col"><label>&nbsp;</label><button class="btn btn-primary" onclick="generateDaily()">عرض التقرير</button></div>
      <div class="col"><label>&nbsp;</label><button class="btn btn-outline" onclick="printSection('dailyWrap')">🖨️ طباعة PDF</button></div>
    </div>
    <div id="dailyWrap"></div>
  </section>

  <!-- تقرير فترة / مجمّع + صندوق المالك -->
  <section class="card" data-tab="range">
    <h3>تقرير فترة / مجمّع</h3>
    <div class="row print-hide">
      <div class="col"><label>من</label><input type="date" id="f_from"></div>
      <div class="col"><label>إلى</label><input type="date" id="f_to"></div>
      <div class="col"><label>النمط</label>
        <select id="f_mode">
          <option value="per">منفصل لكل محل</option>
          <option value="all">مجمّع للمحلات الثلاثة</option>
        </select>
      </div>
      <div class="col"><label>&nbsp;</label><button class="btn btn-primary" onclick="generateRange()">عرض التقرير</button></div>
      <div class="col"><label>&nbsp;</label><button class="btn btn-outline" onclick="printSection('rangeWrap')">🖨️ طباعة PDF</button></div>
    </div>
    <div id="rangeWrap"></div>
  </section>

  <!-- صندوق المالك: تبويب مستقل -->
  <section class="card" data-tab="owner">
    <h3>صندوق المالك — كشف فوري</h3>
    <div class="row print-hide">
      <div class="col"><label>من</label><input type="date" id="of_from"></div>
      <div class="col"><label>إلى</label><input type="date" id="of_to"></div>
      <div class="col"><label>&nbsp;</label><button class="btn btn-primary" onclick="renderOwnerStatement()">عرض الكشف</button></div>
      <div class="col"><label>&nbsp;</label><button class="btn btn-outline" onclick="printSection('ownerWrap')">🖨️ طباعة PDF</button></div>
    </div>
    <div id="ownerWrap"></div>

    <div class="subtle print-hide" style="margin-top:12px">
      <h4>صيانة الصندوق (للتعامل مع الأرقام العالقة)</h4>
      <div class="row">
        <div class="col"><label>من</label><input type="date" id="maint_from"></div>
        <div class="col"><label>إلى</label><input type="date" id="maint_to"></div>
      </div>
      <div class="row">
        <div class="col"><button class="btn btn-danger" onclick="removeSettlementsInRange()">🗑️ حذف تسويات الفترة</button></div>
        <div class="col"><button class="btn btn-primary" onclick="recomputeSettlementsInRange()">🔄 إعادة احتساب تسويات الفترة</button></div>
      </div>
      <div class="hint">الحذف/إعادة الاحتساب تشمل فقط التسويات الآلية (ترحيل كاش اليوم)، ولا تمسّ الحركات اليدوية أو دفعات التجار والسلف.</div>
    </div>
  </section>
</main>

<nav class="tabs print-hide">
  <div class="tab active"><button onclick="showTab('input')">إدخال</button></div>
  <div class="tab"><button onclick="showTab('daily')">يومي</button></div>
  <div class="tab"><button onclick="showTab('range')">فترة/مجمّع</button></div>
  <div class="tab"><button onclick="showTab('loans')">السُلف</button></div>
  <div class="tab"><button onclick="showTab('traders')">التجار</button></div>
  <div class="tab"><button onclick="showTab('owner')">المالك</button></div>
</nav>

<script>
// ===== Helpers & Storage =====
const stores={store1:"روان بيبي",store2:"جنتل بيبي عبود",store3:"بسطة"};let currentStore="store1";
const qs=(s)=>document.querySelector(s);
function todayISO(){return new Date().toISOString().slice(0,10)}
function fmtDatePretty(iso){const d=new Date(iso+"T00:00:00");const days=["الأحد","الإثنين","الثلاثاء","الأربعاء","الخميس","الجمعة","السبت"];const dd=String(d.getDate()).padStart(2,"0");const mm=String(d.getMonth()+1).padStart(2,"0");const yyyy=d.getFullYear();return `${days[d.getDay()]} ${yyyy}-${mm}-${dd}`}
function uid(){return Date.now().toString(36)+Math.random().toString(36).slice(2,7)}

function getData(store=currentStore){return JSON.parse(localStorage.getItem(store)||'{"sales":[],"expenses":[]}')}
function saveData(store=currentStore,data){localStorage.setItem(store,JSON.stringify(data))}

// Owner fund
function getOwner(){return JSON.parse(localStorage.getItem('owner_fund')||'{"ledger":[]}')}
function saveOwner(v){localStorage.setItem('owner_fund',JSON.stringify(v))}
function ownerIn(amount,note,meta){const O=getOwner();O.ledger.push({id:uid(),date:todayISO(),type:'in',amount:+amount,note,meta:meta||{}});saveOwner(O);updateOwnerBalanceUI()}
function ownerOut(amount,note,meta){const O=getOwner();O.ledger.push({id:uid(),date:todayISO(),type:'out',amount:+amount,note,meta:meta||{}});saveOwner(O);updateOwnerBalanceUI()}

// Loans (سُلف)
function getLoans(){return JSON.parse(localStorage.getItem('loans')||'{"list":[]}')}
function saveLoans(v){localStorage.setItem('loans',JSON.stringify(v))}
function refreshLoanSelects(){const v=getLoans().list;['loan_person','repay_person','exp_lender'].forEach(id=>{const sel=qs('#'+id);if(!sel)return;sel.innerHTML=v.length?v.map(o=>`<option value="${o.id}">${o.name}</option>`).join(''):'<option value="">— لا يوجد مسلفون —</option>';})}
function renderLendersList(){const v=getLoans().list;const wrap=qs('#lendersList');if(!wrap)return;if(!v.length){wrap.innerHTML='<div class="hint">لا يوجد مُسلفون</div>';return}wrap.innerHTML=v.map(L=>{const adv=L.advanced||0,used=L.used||0,rep=L.repaid||0;const stillOnUs=adv-rep;const remain=Math.max(0,adv-used);return `<div class="item"><div class="meta"><b>${L.name}</b> ${L.phone?('— '+L.phone):''}<div class="hint">علينا الآن: <b>${stillOnUs}</b> — غير مستخدم: <b>${remain}</b></div></div><div><button class="btn btn-danger" onclick="deleteLender('${L.id}')">حذف</button></div></div>`}).join('')}
function addLender(){const name=(qs('#l_name').value||'').trim();const phone=(qs('#l_phone').value||'').trim();if(!name){alert('أدخل اسم المُسلف');return}const D=getLoans();D.list.push({id:uid(),name,phone,ledger:[],advanced:0,used:0,repaid:0});saveLoans(D);qs('#l_name').value='';qs('#l_phone').value='';renderLoansUI()}
function deleteLender(id){const D=getLoans();const i=D.list.findIndex(x=>x.id===id);if(i>-1&&confirm('حذف هذا المُسلف وكافة حركاته؟')){D.list.splice(i,1);saveLoans(D);renderLoansUI()}}
function deleteLenderEntry(lid,eid){const D=getLoans();const L=D.list.find(x=>x.id===lid);if(!L)return;const i=(L.ledger||[]).findIndex(x=>x.id===eid);if(i>-1&&confirm('حذف هذه الحركة؟')){L.ledger.splice(i,1);recomputeLender(L);saveLoans(D);renderLoansUI()}}
function recomputeLender(L){let adv=0,used=0,rep=0;(L.ledger||[]).forEach(e=>{if(e.type==='advance')adv+=(+e.amount||0);else if(e.type==='use')used+=(+e.amount||0);else if(e.type==='repay')rep+=(+e.amount||0)});L.advanced=adv;L.used=used;L.repaid=rep}
function takeLoan(){const id=(qs('#loan_person')||{}).value;const amt=parseFloat((qs('#loan_amount').value||'0'));const note=(qs('#loan_note').value||'').trim();if(!id||!amt){alert('اختر مُسلف وأدخل مبلغ');return}const D=getLoans();const L=D.list.find(x=>x.id===id);(L.ledger||(L.ledger=[])).push({id:uid(),type:'advance',date:todayISO(),amount:amt,note});recomputeLender(L);saveLoans(D);qs('#loan_amount').value='';qs('#loan_note').value='';renderLoansUI();alert('تم تسجيل السلفة.')} 
function repayLoan(){const id=(qs('#repay_person')||{}).value;const amt=parseFloat((qs('#repay_amount').value||'0'));const note=(qs('#repay_note').value||'').trim();const src=(qs('#repay_source')||{}).value||'shop_cash';if(!id||!amt){alert('اختر مُسلف وأدخل مبلغ');return}const D=getLoans();const L=D.list.find(x=>x.id===id);(L.ledger||(L.ledger=[])).push({id:uid(),type:'repay',date:todayISO(),amount:amt,note,source:src});recomputeLender(L);saveLoans(D);
// سجل المصدر
if(src==='shop_cash'){const d=getData();d.expenses.push({id:uid(),date:todayISO(),type:'كاش',desc:`سداد سلفة (${L.name})`,amount:amt,note:note||'من كاش المحل'});saveData(currentStore,d)}
if(src==='owner_cash'){ownerOut(amt, `سداد سلفة (${L.name}) — ${note||''}`, {kind:'loan_repay', lenderId:id})}
qs('#repay_amount').value='';qs('#repay_note').value='';renderLoansUI();updateOwnerBalanceUI();alert('تم تسجيل السداد.')} 
function renderLoansUI(){refreshLoanSelects();renderLendersList()}

// Sales & Expenses
function changeStore(){currentStore=qs('#storeSelect').value;renderLists()}
function addSale(){const a=parseFloat((qs('#saleAmount').value||'0'));const t=qs('#saleType').value;const n=(qs('#saleNote').value||'').trim();if(!a){alert('أدخل مبلغ صحيح');return}const d=getData();d.sales.push({id:uid(),date:todayISO(),type:t,amount:a,note:n});saveData(currentStore,d);qs('#saleAmount').value='';qs('#saleNote').value='';renderLists()}
function toggleExpenseTarget(){const val=qs('#expenseTarget').value;qs('#expLenderRow').style.display=(val==='lender')?'flex':'none';qs('#expTraderRow').style.display=(val==='trader')?'flex':'none'}
function addExpense(){const desc=(qs('#expenseDesc').value||'').trim();const a=parseFloat((qs('#expenseAmount').value||'0'));const t=qs('#expenseType').value;const target=qs('#expenseTarget').value;const n=(qs('#expenseNote').value||'').trim();if(!desc||!a){alert('أدخل وصف ومبلغ صحيح');return}const d=getData();d.expenses.push({id:uid(),date:todayISO(),type:t,desc:desc,amount:a,note:n});saveData(currentStore,d);
// سداد لمسلف من المصاريف
if(target==='lender'){const lid=(qs('#exp_lender')||{}).value;const src=(qs('#exp_lender_source')||{}).value||'shop_cash';const D=getLoans();const L=D.list.find(x=>x.id===lid);if(L){(L.ledger||(L.ledger=[])).push({id:uid(),type:'repay',date:todayISO(),amount:a,note:desc+' — '+n,source:src});recomputeLender(L);saveLoans(D);if(src==='owner_cash'){ownerOut(a, `سداد سلفة (${L.name}) عبر المصاريف — ${desc}`, {kind:'loan_repay', lenderId:lid})}}}
// سداد لتاجر عبر المصاريف
if(target==='trader'){const tid=(qs('#exp_trader')||{}).value;const T=getTraders();const tr=T.list.find(x=>x.id===tid);if(tr){let sc=0,sb=0,oc=0;if(t==='كاش')sc=a;else if(t==='بنك')sb=a;(tr.ledger||(tr.ledger=[])).push({id:uid(),type:'payment',date:todayISO(),amount:a,pay_shop_cash:sc,pay_shop_bank:sb,pay_owner_cash:oc,note:desc+' — '+n});recomputeTrader(tr);saveTraders(T);}}
qs('#expenseDesc').value='';qs('#expenseAmount').value='';qs('#expenseNote').value='';renderLists();updateOwnerBalanceUI()}
function deleteSale(id){const d=getData();const i=d.sales.findIndex(x=>x.id===id);if(i>-1&&confirm('حذف عملية البيع؟')){d.sales.splice(i,1);saveData(currentStore,d);renderLists()}}
function deleteExpense(id){const d=getData();const i=d.expenses.findIndex(x=>x.id===id);if(i>-1&&confirm('حذف عملية المصروف؟')){d.expenses.splice(i,1);saveData(currentStore,d);renderLists()}}
function renderLists(){const d=getData();const rs=d.sales.slice(-20).reverse();const re=d.expenses.slice(-20).reverse();const rsHtml=rs.map(v=>`<div class="item"><div class="meta">${v.date} — <span class="tag">${v.type}</span> ${v.note?('— <i>'+v.note+'</i>'):''}</div><div><b>${v.amount}</b></div><div><button class="btn btn-danger" onclick="deleteSale('${v.id}')">حذف</button></div></div>`).join('')||'<div class="hint">لا توجد مبيعات بعد</div>';const reHtml=re.map(v=>`<div class="item"><div class="meta">${v.date} — <span class="tag">${v.type}</span> — ${v.desc} ${v.note?('— <i>'+v.note+'</i>'):''}</div><div><b>${v.amount}</b></div><div><button class="btn btn-danger" onclick="deleteExpense('${v.id}')">حذف</button></div></div>`).join('')||'<div class="hint">لا توجد مصاريف بعد</div>';qs('#recentSales').innerHTML=rsHtml;qs('#recentExpenses').innerHTML=reHtml}

// Traders data
function getTraders(){return JSON.parse(localStorage.getItem('traders')||'{"list":[]}')}
function saveTraders(v){localStorage.setItem('traders',JSON.stringify(v))}
function refreshTraderSelects(){const v=getTraders().list;['p_trader','pay_trader','s_trader','exp_trader'].forEach(id=>{const sel=qs('#'+id);if(!sel)return;sel.innerHTML=v.length?v.map(o=>`<option value="${o.id}">${o.name}</option>`).join(''):'<option value="">— لا يوجد تجار —</option>';})}
function addTrader(){const name=(qs('#t_name').value||'').trim();const phone=(qs('#t_phone').value||'').trim();if(!name){alert('أدخل اسم التاجر');return}const T=getTraders();T.list.push({id:uid(),name,phone,balance:0,ledger:[]});saveTraders(T);qs('#t_name').value='';qs('#t_phone').value='';renderTradersUI()}
function deleteTrader(id){const T=getTraders();const i=T.list.findIndex(x=>x.id===id);if(i>-1&&confirm('حذف هذا التاجر مع كل حركاته؟')){T.list.splice(i,1);saveTraders(T);renderTradersUI()}}
function deleteTraderEntry(tid,eid){const T=getTraders();const t=T.list.find(x=>x.id===tid);if(!t)return;const i=(t.ledger||[]).findIndex(x=>x.id===eid);if(i>-1&&confirm('حذف هذه الحركة؟')){t.ledger.splice(i,1);recomputeTrader(t);saveTraders(T);renderTradersUI()}}
function recomputeTrader(t){let bal=0;(t.ledger||[]).forEach(e=>{if(e.type==='purchase'){const remain=(+e.amount||0)-((+e.pay_shop_cash||0)+(+e.pay_shop_bank||0)+(+e.pay_owner_cash||0));bal+=remain}else if(e.type==='payment'){bal-= (+e.amount||0); if(bal<0) bal=0}e.balance_after=bal});t.balance=bal}
function renderTradersUI(){refreshTraderSelects();renderTradersList()}
function renderTradersList(){const v=getTraders().list;const wrap=qs('#tradersList');if(!wrap)return;wrap.innerHTML=v.length?v.map(o=>`<div class="item"><div class="meta"><b>${o.name}</b> ${o.phone?('— '+o.phone):''} <span class="hint">| الرصيد: ${o.balance||0}</span></div><div><button class="btn btn-danger" onclick="deleteTrader('${o.id}')">حذف</button></div></div>`).join(''):'<div class="hint">لا يوجد تجار</div>'}

// Owner Statement tab
function renderOwnerStatement(){
  const from=(qs('#of_from')||{}).value || todayISO().slice(0,8)+'01';
  const to  =(qs('#of_to')||{}).value   || todayISO();
  const O=getOwner();
  const rows=(O.ledger||[]).filter(x=>inRange(x.date,from,to));
  const inSum=rows.filter(x=>x.type==='in').reduce((a,b)=>a+(+b.amount||0),0);
  const outSum=rows.filter(x=>x.type==='out').reduce((a,b)=>a+(+b.amount||0),0);
  const bal=inSum-outSum;
  const tableRows=rows.length?rows.map(e=>`
    <tr>
      <td>${e.date}</td>
      <td>${e.type==='in'?'تحصيل':'صرف'}</td>
      <td>${e.amount}</td>
      <td>${e.note||''}</td>
    </tr>`).join(''):`<tr><td colspan="4">لا توجد حركات ضمن الفترة</td></tr>`;
  qs('#ownerWrap').innerHTML = `
    <div class="page">
      <h2 style="margin:0 0 8px">كشف صندوق المالك</h2>
      <div class="hint">الفترة: <b>${from}</b> → <b>${to}</b> — تاريخ الطباعة: <b>${fmtDatePretty(todayISO())}</b></div>
      <div class="separator"></div>
      <table>
        <thead><tr><th>التاريخ</th><th>النوع</th><th>المبلغ</th><th>الملاحظة</th></tr></thead>
        <tbody>${tableRows}</tbody>
      </table>
      <div style="margin-top:10px">
        <span class="badge">الإجمالي تحصيل: <b>${inSum}</b></span>
        <span class="badge" style="margin-inline:6px">الإجمالي صرف: <b>${outSum}</b></span>
        <span class="badge">الرصيد للفترة: <b>${bal}</b></span>
      </div>
      <div style="margin-top:40px;display:flex;justify-content:space-between">
        <div>توقيع المالك: عبد الله أبو عوض ____________________</div>
        <div>توقيع المدير المالي: ____________________</div>
      </div>
    </div>`;
}

// Maintenance helpers
function inRange(iso,from,to){const d=new Date(iso+"T00:00:00");return d>=new Date(from+"T00:00:00")&&d<=new Date(to+"T00:00:00")}
function dateAddDays(iso,days){const d=new Date(iso+"T00:00:00");d.setDate(d.getDate()+days);return d.toISOString().slice(0,10)}
function eachDate(from,to,fn){let cur=from;while(cur<=to){fn(cur);cur=dateAddDays(cur,1)}}

function removeSettlementsInRange(){
  const from=(qs('#maint_from')||{}).value || todayISO().slice(0,8)+'01';
  const to  =(qs('#maint_to')||{}).value   || todayISO();
  const O=getOwner();
  for(let i=(O.ledger||[]).length-1;i>=0;i--){
    const e=O.ledger[i], meta=e.meta||{};
    const isSettle=(meta.kind==='settle') || (typeof e.note==='string' && e.note.indexOf('ترحيل كاش اليوم من')===0);
    if(isSettle && inRange(e.date,from,to)){ O.ledger.splice(i,1); }
  }
  saveOwner(O); updateOwnerBalanceUI(); renderOwnerStatement(); alert('تم حذف تسويات الفترة المحددة من صندوق المالك.');
}

function recomputeSettlementsInRange(){
  const from=(qs('#maint_from')||{}).value || todayISO().slice(0,8)+'01';
  const to  =(qs('#maint_to')||{}).value   || todayISO();
  // أولاً: احذف التسويات الحالية ضمن الفترة
  const O=getOwner();
  for(let i=(O.ledger||[]).length-1;i>=0;i--){
    const e=O.ledger[i], meta=e.meta||{};
    const isSettle=(meta.kind==='settle') || (typeof e.note==='string' && e.note.indexOf('ترحيل كاش اليوم من')===0);
    if(isSettle && inRange(e.date,from,to)){ O.ledger.splice(i,1); }
  }
  saveOwner(O);
  // ثم: أعد احتساب تسوية كل يوم لكل محل
  const shops=Object.keys(stores);
  eachDate(from,to,(day)=>{
    shops.forEach(storeKey=>{
      const d=JSON.parse(localStorage.getItem(storeKey)||'{"sales":[],"expenses":[]}');
      const cashSales=(d.sales||[]).filter(x=>x.date===day && x.type==='كاش').reduce((a,b)=>a+(+b.amount||0),0);
      const cashExp  =(d.expenses||[]).filter(x=>x.date===day && x.type==='كاش').reduce((a,b)=>a+(+b.amount||0),0);
      const net=cashSales-cashExp;
      if(net>0){
        const O2=getOwner();
        (O2.ledger||[]).push({id:uid(),date:day,type:'in',amount:+net,
          note:`ترحيل كاش اليوم من ${stores[storeKey]}`,
          meta:{kind:'settle', store:storeKey, date_ref:day}});
        saveOwner(O2);
      }
    });
  });
  updateOwnerBalanceUI(); renderOwnerStatement(); alert('تمت إعادة احتساب التسويات للفترة.');
}

// Print
function printSection(id){const el=document.getElementById(id);if(!el||!el.innerHTML.trim()){alert('اعرض التقرير أولاً');return}const w=window.open('','_blank');const css=document.querySelector('style').outerHTML;const h=`<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="utf-8"/><title>طباعة</title>${css}</head><body>${el.innerHTML}</body></html>`;w.document.write(h);w.document.close();w.focus();w.print()}

// Owner balance UI
function updateOwnerBalanceUI(){
  const O=getOwner();
  const inSum=(O.ledger||[]).filter(x=>x.type==='in').reduce((a,b)=>a+(+b.amount||0),0);
  const outSum=(O.ledger||[]).filter(x=>x.type==='out').reduce((a,b)=>a+(+b.amount||0),0);
  const bal=inSum-outSum;
  const el=qs('#ownerBalanceVal'); if(el) el.textContent=bal;
  return bal;
}

// ===== Idempotent Settlement (per store, per day) =====
function upsertOwnerSettlement(storeKey, dateISO, amount){
  const O=getOwner();
  for(let i=(O.ledger||[]).length-1;i>=0;i--){
    const e=O.ledger[i];
    const meta=e.meta||{};
    const isSettleByMeta = meta && meta.kind==='settle' && meta.store===storeKey && meta.date_ref===dateISO;
    const isSettleByNote = typeof e.note==='string' && e.note.indexOf('ترحيل كاش اليوم من')===0 && e.note.indexOf(stores[storeKey])>-1 && e.date===dateISO && e.type==='in';
    if(isSettleByMeta || isSettleByNote){ O.ledger.splice(i,1); }
  }
  if(amount>0){
    (O.ledger||[]).push({id:uid(),date:dateISO,type:'in',amount:+amount,
      note:`ترحيل كاش اليوم من ${stores[storeKey]}`,
      meta:{kind:'settle', store:storeKey, date_ref:dateISO}});
  }
  saveOwner(O);
  updateOwnerBalanceUI();
}

function settleDay(){
  const input=qs('#todayInput'); const today = (input && input.value) ? input.value : todayISO();
  const d=getData();
  const cashSales=d.sales.filter(x=>x.date===today && x.type==='كاش').reduce((a,b)=>a+(+b.amount||0),0);
  const cashExp  =d.expenses.filter(x=>x.date===today && x.type==='كاش').reduce((a,b)=>a+(+b.amount||0),0);
  const net=cashSales-cashExp;
  if(net<=0){
    upsertOwnerSettlement(currentStore, today, 0);
    alert('لا يوجد كاش فائض للترحيل (تم إزالة أي تسوية سابقة لليوم إن وُجدت).');
    return;
  }
  upsertOwnerSettlement(currentStore, today, net);
  alert(`تم تثبيت التسوية لليوم بمبلغ ${net} (تسوية واحدة فقط لليوم).`);
}

// Tabs & boot
function showTab(name){document.querySelectorAll('[data-tab]').forEach(s=>s.style.display=(s.getAttribute('data-tab')===name)?'block':'none');const order=['input','daily','range','loans','traders','owner'];document.querySelectorAll('.tabs .tab').forEach((t,i)=>t.classList.toggle('active',order[i]===name));if(name==='input')renderLists();if(name==='loans')renderLoansUI();if(name==='traders')renderTradersUI();if(name==='owner')renderOwnerStatement()}
function initDates(){const t=todayISO();['todayInput','r_date','maint_from','of_from','f_from','ts_from'].forEach(id=>{const x=qs('#'+id);if(x)x.value=t.slice(0,8)+'01'});['maint_to','of_to','f_to','ts_to'].forEach(id=>{const x=qs('#'+id);if(x)x.value=t})}
document.addEventListener('DOMContentLoaded',()=>{initDates();showTab('input');renderLists();refreshLoanSelects();refreshTraderSelects();updateOwnerBalanceUI()});
</script>
</body>
</html>
